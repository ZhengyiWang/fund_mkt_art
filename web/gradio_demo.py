import gradio as gr
import pandas as pd
import requests

bond_type=f'最新热点资讯：>>>>>>央行今日进行1500亿元7天期逆回购操作，中标利率为1.80%，与此前持平。因今日有20亿元7天期逆回购到期，实现净投放1480亿元。<<<<<<\n客户持仓基金类型：>>>>>>股类<<<<<\n客户持仓基金第一大重仓股：>>>>>>无<<<<<<\n请根据上述信息生成两句话，不超过100字，如果客户持仓基金类型是股型，则指出客户持仓基金的第一大重仓股是什么（不需要点评这只股票），如果客户持仓基金类型是债型，则指出客户持仓基金类型，并表述<我一直关注市场最新热点资讯，>，然后一句话总结最新热点资讯，要求体现你的专业视角和分析能力，对市场的判断力，且能够和别人共情，要求符合与客户电话沟通的语言风格,客户是单个人，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要提投资建议和投资策略，不要打招呼或称谓用语，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词，不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。'
contents=["生成一段投顾自我介绍话术",
 f'最新热点资讯：>>>>>>最近的市场新闻中，恒瑞医药与北京大学肿瘤医院云南医院签署了战略合作协议，这将为其在抗肿瘤新药研发和药物临床研究方面带来新的机遇，也可能对其股价产生积极影响。<<<<<<\n客户持仓基金类型：>>>>>>股类<<<<<<\n客户持仓基金第一大重仓股：>>>>>>恒瑞医药<<<<<<\n请根据上述信息生成两句话，不超过100字，如果客户持仓基金类型是股型，则指出客户持仓基金的第一大重仓股是什么（不需要点评这只股票），如果客户持仓基金类型是债型，则指出客户持仓基金类型，并表述<我一直关注市场最新热点资讯，>，然后一句话总结最新热点资讯，要求体现你的专业视角和分析能力，对市场的判断力，且能够和别人共情，要求符合与客户电话沟通的语言风格,客户是单个人，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要提投资建议和投资策略，不要打招呼或称谓用语，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词，不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。',
 '客户持仓基金名称：>>>>>>易方达竞争优势企业混合A<<<<<<\n客户持仓基金是否为重点营销产品：>>>>>>是<<<<<<\n客户持仓基金弱点：>>>>>>收益率低,获取超额收益能力弱<<<<<<\n客户持仓基金优点：>>>>>>稳定性高<<<<<<\n请根据上述信息生成一段话，以<您持仓的基金>为开头，首先一句话简单地夸赞一下客户持仓基金的优点（这句话以<在同类产品中>开头，客户持仓基金优点为无时，表述<已经陪伴您有一段时间了>，这句话到这为止），语言措辞不要夸张，如果客户持仓基金不是重点营销产品，就生成一句话委婉地点出客户持仓基金的弱点，并表示对客户的关心，如果客户持仓基金是重点营销产品，则一句话强调你对客户的持续陪伴与关心，以及你想要帮助他分析和给予他投资建议的话术，不超过100个字，要求符合与客户电话沟通的语言风格，不要说您好，话语里不能出现客户两个字,不要打招呼或称谓用语，不要提投资建议和投资策略，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要提重点营销产品，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词，不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。整段内容范例：您持仓的基金易方达竞争优势企业混合A，稳定性较高。但是，咱们也看到它的收益率有些低，获取超额收益的能力稍显不足。我是您的投资顾问，就像您的财富守护者，希望能帮您分析这些问题，让您的投资更加明智。',
 '客户持仓基金名称：>>>>>>易方达竞争优势企业混合A<<<<<<\n客户持仓基金是否为重点营销产品：>>>>>>是<<<<<<\n客户持仓基金点评：>>>>>>易方达竞争优势企业混合A在6842只业绩满一年的混合型基金中,评级为2（满分5）,整体表现较差,其中,盈利能力较差,抗风险力极差选股能力一般,择时能力优秀。<<<<<<\n客户持仓基金弱点：>>>>>>收益率低,获取超额收益能力弱<<<<<<\n客户持仓基金优点：>>>>>>无<<<<<<\n基金指标截取日期范围：>>>>>>近三月<<<<<<\n年化收益率：>>>>>>-19.97%<<<<<<\n年化波动率：>>>>>>18.48%<<<<<<\n最大回撤：>>>>>>-55.86%<<<<<<\n夏普比率：>>>>>>-1.1138<<<<<<\n卡玛比率：>>>>>>-0.3575<<<<<<\nα比率：>>>>>>-0.0628<<<<<<\n重仓行业：>>>>>>酒、饮料和精制茶制造业<<<<<<\n持股集中度：>>>>>>52.86%<<<<<<\n资产子类别及占比：>>>>>>酒、饮料和精制茶制造业(30.96%),医药制造业(5.9%),汽车制造业(3.21%)<<<<<<\n十大持仓股及占比：>>>>>>恒瑞医药(5.9%),贵州茅台(9.56%),星宇股份(3.21%),迎驾贡酒(3.08%),泸州老窖(6.31%),古井贡酒(5.5%),五粮液(6.51%),华润啤酒(3.04%),腾讯控股(6.53%),李宁(3.22%)<<<<<<\n基金资产分布：>>>>>>买入返售金融资产(占比0%),债券资产(占比0%),银行存款返回资产(占比9.51%),股票资产(占比90.34%),其他资产(占比0.15%)<<<<<<\n基金的投资风格：>>>>>>偏稳健型<<<<<<\n单位累计净值：>>>>>>0.4997<<<<<<\n基金月度排名：>>>>>>4147/8349<<<<<<\n基金季度排名：>>>>>>3634/8533<<<<<<\n基金年度排名：>>>>>>6738/7500<<<<<<\n基金经理年化回报：>>>>>>-45.2863%<<<<<<\n前10股票占资产总比值：>>>>>>52.86%<<<<<<\n前5债券占资产总值比：>>>>>>0%<<<<<<请根据上述基金的详细信息生成一段话，以<您持仓的基金>开头，不包含投顾的信息，包含对客户持仓基金各项指标与基金特点的综合分析和概括总结（不超过100字，体现专业性），尤其是分析这几个指标：年化收益率、最大回撤、夏普比率，指标分析以近三月开头，以及根据客户持仓基金特点进行归因分析，找到基金弱点的原因，如果客户持仓基金是重点营销产品，则不要出现任何贬低该基金的负面词汇，总共不超过200个字，要求符合与客户电话沟通的语言风格，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要提重点营销产品，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词,不要打招呼或称谓用语,不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。整段内容范例：您持仓的基金易方达竞争优势企业混合A，整体表现较差，在您持仓期间，年化收益率为-19.97%，波动率18.48%，最大回撤高达-55.86%，这些数据都显示出基金的收益能力和抗风险能力较弱。尽管择时能力优秀，但是在选股方面只能算一般，这可能是导致收益率低的原因。基金重仓行业为酒、饮料和精制茶制造业，持股集中度高达52.86%，这种高度集中的投资策略可能会增加风险。基金的投资风格偏稳健，但是在当前的市场环境下，可能需要更加灵活的投资策略来应对。',
 '客户持仓产品弱点：>>>>>>收益率低,获取超额收益能力弱<<<<<<\n客户持仓基金是否为重点营销产品：>>>>>>是<<<<<<\n客户持仓基金与营销产品是否同类：>>>>>>是<<<<<<\n营销基金代码：>>>>>>000979<<<<<<\n营销基金名称：>>>>>>景顺长城沪港深精选股票<<<<<<\n营销基金点评：>>>>>>景顺长城沪港深精选股票在835只业绩满一年的股票型基金中,评级为4（满分5）,整体表现优秀,其中,盈利能力优秀,抗风险能力优秀,选股能力优秀。<<<<<<\n营销基金弱点：>>>>>>无<<<<<<\n营销基金优点：>>>>>>收益率高,稳定性高,获取超额收益能力强<<<<<<\n请根据上述信息生成一段话，称谓客户为您，不包含投顾的信息，包含改善客户持仓基金弱点的投资方向建议（一句话），如果客户持仓基金是重点营销产品，则不要包含任何贬低客户持仓基金的词汇，另外生成营销基金的介绍（包括基金代码），突出营销基金的优点，不超过100个字，如果客户持仓基金与营销产品不是同类基金，则增加一句话该基金与您持有基金属于不同基金类别，业绩比较基准或存在明显差异，请知悉。，要求符合与客户电话沟通的语言风格，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要提重点营销产品，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词,不要打招呼或称谓用语,不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。整段内容范例：我发现您的持仓产品收益率较低，为了改善这个问题，我建议您关注一下景顺长城沪港深精选股票（基金代码：000979）。这款基金收益率高、稳定性强，获取超额收益的能力非常强，相信能为您带来更好的投资回报。',
 '客户持仓基金概述：>>>>>>您持仓的基金易方达竞争优势企业混合A近三月数据显示，年化收益率为-19.97%，反映出近期市场挑战较大；最大回撤达到-55.86%，显示了较高的波动风险，而夏普比率为负(-1.1138)，表明单位风险所获得的收益欠佳。基金侧重于酒类制造等消费板块，持股集中度较高，虽体现了偏稳健的投资取向，但在近期市场调整中，该策略效果未达预期，特别是盈利能力与抗风险能力评价较低，可能是由于行业配置及个股选择上的集中度与市场风格阶段性不匹配所致。后续关注市场风格变化及基金策略调整，以期改善表现。<<<<<<\n\n营销基金名称：>>>>>>景顺长城沪港深精选股票<<<<<<\n营销基金代码：>>>>>>000979<<<<<<\n营销基金点评：>>>>>>景顺长城沪港深精选股票在835只业绩满一年的股票型基金中,评级为4（满分5）,整体表现优秀,其中,盈利能力优秀,抗风险能力优秀,选股能力优秀。<<<<<<\n营销基金弱点：>>>>>>无<<<<<<\n营销基金优点：>>>>>>收益率高,稳定性高,获取超额收益能力强<<<<<<\n营销基金指标截取日期范围：>>>>>>近三月<<<<<<\n营销基金年化收益率：>>>>>>10.05%<<<<<<\n营销基金年化波动率：>>>>>>13.23%<<<<<<\n营销基金最大回撤：>>>>>>-15.38%<<<<<<\n营销基金夏普比率：>>>>>>0.7911<<<<<<\n营销基金卡玛比率：>>>>>>0.6536<<<<<<\n营销基金α比率：>>>>>>0.1282<<<<<<\n营销基金重仓行业：>>>>>>电力、热力生产和供应业<<<<<<\n营销基金持股集中度：>>>>>>53.5%<<<<<<\n营销基金资产子类别及占比：>>>>>>电力、热力生产和供应业(15.2%),批发业(2.5%),煤炭开采和洗选业(2.75%),有色金属矿采选业(9.65%),化学原料及化学制品制造业(2.92%),有色金属冶炼和压延加工业(4.31%),金属制品业(2.83%)<<<<<<\n营销基金十大持仓股及占比：>>>>>>华能水电(8.11%),山煤国际(2.5%),川投能源(7.09%),陕西煤业(2.75%),紫金矿业(9.65%),广信股份(2.92%),铜陵有色(4.31%),久立特材(2.83%),中国海洋石油(8.32%),中国移动(5.02%)<<<<<<\n营销基金基金资产分布：>>>>>>买入返售金融资产(占比4.93%),债券资产(占比0%),银行存款返回资产(占比7.68%),股票资产(占比87.23%),其他资产(占比0.16%)<<<<<<\n营销基金的投资风格：>>>>>>稳健型<<<<<<\n营销基金单位累计净值：>>>>>>2.048<<<<<<\n营销基金月度排名：>>>>>>820/1005<<<<<<\n营销基金季度排名：>>>>>>277/1013<<<<<<\n营销基金年度排名：>>>>>>13/907<<<<<<\n营销基金的基金经理年化回报：>>>>>>53.38%<<<<<<\n营销基金前10股票占资产总比值：>>>>>>53.5%<<<<<<\n营销基金前5债券占资产总值比：>>>>>>0%<<<<<<\n请根据上述信息生成一段话，不要包含投顾的信息，包含深入挖掘上述信息，对营销基金进行综合分析（包括和客户持仓基金进行对比分析）和概括总结，尤其是这几个指标的对比分析：{Evaluation_indicators}，指标分析以近三月开头，把对比的数值差距描述出来，突出营销基金的优点(以在同类产品中开头)，点出对比指标的具体数值，指标名称要说全，不超过200个字，要求符合与客户电话沟通的语言风格和体现投顾的专业性，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词,不要打招呼或称谓用语,不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。整段内容范例：看来我们需要对比一下易方达竞争优势企业混合A和景顺长城沪港深精选股票这两只基金。首先，景顺长城沪港深精选股票的年化收益率为10.05%，相比易方达竞争优势企业混合A的-45.29%，收益率高出了55.34个百分点，这是一个显著的优势。其次，景顺长城沪港深精选股票的最大回撤为-15.38%，相对较低，说明其抗风险能力较强。再者，该基金的夏普比率为0.7911，卡玛比率为0.6536，α比率为0.1282，这些都显示出其获取超额收益的能力强。最后，该基金的基金经理年化回报为53.38%，远高于易方达竞争优势企业混合A的基金经理年化回报，说明其基金经理的管理能力较强。总的来说，景顺长城沪港深精选股票在收益率、抗风险能力、获取超额收益能力以及基金经理的管理能力等方面都表现出了显著的优势。',
 '投顾选择的指标：年化收益率、最大回撤、夏普比率\n客户持仓基金概述：您持仓的基金易方达竞争优势企业混合A近三月数据显示，年化收益率为-19.97%，反映出近期市场挑战较大；最大回撤达到-55.86%，显示了较高的波动风险，而夏普比率为负(-1.1138)，表明单位风险所获得的收益欠佳。基金侧重于酒类制造等消费板块，持股集中度较高，虽体现了偏稳健的投资取向，但在近期市场调整中，该策略效果未达预期，特别是盈利能力与抗风险能力评价较低，可能是由于行业配置及个股选择上的集中度与市场风格阶段性不匹配所致。后续关注市场风格变化及基金策略调整，以期改善表现。\n营销基金概述：对比您目前持有的易方达竞争优势企业混合A与景顺长城沪港深精选股票，近三个月数据揭示了显著差异。景顺长城沪港深精选（代码000979）展现出强劲性能，年化收益率高达10.05%，不仅转负为正，且与您持仓基金的-19.97%形成鲜明对比，波动率更低至13.23%，最大回撤控制在-15.38%，大幅优于您现有基金的-55.86%，体现出更强的稳定性与风险控制能力。其夏普比率0.7911，卡玛比率0.6536，均优于您持仓基金，α比率为0.1282，反映其卓越的主动管理效益。此外，基金经理年化回报高达53.38%，凸显管理团队的实力。综上，景顺长城沪港深精选在同类产品中以高收益、高稳定性和杰出的超额收益获取能力脱颖而出。\n解释上述投顾选择的指标、客户持仓基金概述和营销基金概述三部分内容中提到的所有基金指标，只解释提到的基金指标(比如包含比率或者率的名词)，其他指标不要解释，详细解释每个提到的指标的概念和其大小对判断基金好坏的影响，不超过300个字，指标间要有换行符且为一个，要求通俗易懂、符合与客户电话沟通的语言风格和专业化，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词，不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。整段内容范例：年化收益率，就像你的年终奖，它反映了你投资一年能得到多少回报。如果年化收益率高，那就像你的年终奖发得多，说明基金的表现好；如果年化收益率低，那就像年终奖发得少，说明基金的表现不佳。\n最大回撤，就像你坐过山车，它反映了你的投资在最糟糕的情况下会亏多少。如果最大回撤小，那就像过山车的下坡不陡，说明基金的风险小；如果最大回撤大，那就像过山车的下坡很陡，说明基金的风险大。\n夏普比率，就像你的工作效率，它反映了你投资的收益和承受的风险之间的关系。如果夏普比率高，那就像你工作效率高，说明基金的性价比好；如果夏普比率低，那就像你工作效率低，说明基金的性价比差。所以，选择基金就像找工作，你要看年终奖（年化收益率）高不高，工作压力（最大回撤）大不大，还有工作效率（夏普比率）高不高。',
'客户持仓基金名称：>>>>>>易方达竞争优势企业混合A<<<<<<\n客户持仓基金弱点：>>>>>>收益率低,获取超额收益能力弱<<<<<<\n客户持仓基金与营销产品是否同类：>>>>>>否<<<<<<\n营销基金名称：>>>>>>景顺长城沪港深精选股票<<<<<<\n营销基金优点：>>>>>>收益率高,稳定性高,获取超额收益能力强<<<<<<\n请根据上述信息生成一段话，不包含对客户的称谓，也不包含不打招呼的语言，根据营销基金优点，对客户持仓基金的弱点进行概括性投资方向建议，并询问是否需要基金链接，不要出现营销字样，不超过100个字，如果客户持仓基金与营销产品不是同类基金，则增加一句话该基金与您持有基金属于不同基金类别，业绩比较基准或存在明显差异，请知悉。，要求符合与客户电话沟通的语言风格，句子和段落之间承接要自然，措辞要符合你的投顾风格稳健成熟，不要出现大家好、您好、嗨、哈、哈喽、你好、吧、呢、嘛、啦、哦 、嗯、嘿、哎等语气词,不要打招呼或称谓用语,不得出现下述敏感词：预期收益率、预计收益、抽奖、回扣、安全、保证、承诺、保险、避险、有保障、高收益、无风险、欲购从速、申购良机、业绩最佳、规模最大、保本、名额有限。整段内容范例：看到您持有的易方达竞争优势企业混合A收益率有些低，获取超额收益能力稍弱。我建议您可以考虑一下景顺长城沪港深精选股票，这款基金收益稳定，获取超额收益能力强。需要我发给您详细的基金链接吗？']

def prompt_choose(para,customer,customer_fund,fund_type,ai_fund,news_type,communication_style):
    sys_prompt=f"你是一名专业可靠的证券基金投顾专家，你与人沟通非常生动易理解，你的名字是：小明，你的性别是男，你的投资风格是{communication_style}。"
    content=bond_type if (para== 1 and  fund_type=='债类') else contents[para]
    return sys_prompt,content

# 示例数据
customers = [
    ["1", "张三", "100020583", "36", "1", "C4", "否"],
    ["2", "李四", "100020584", "45", "2", "B2", "是"],
    ["3", "王五", "100020585", "30", "3", "A1", "否"]
]

funds = [
    ["00303", "易方达竞争优势企业混合A", "R1低风险", "00303", " -19.97%", "100,000", "1.06"],
    ["00304", "华夏现金增利基金", "R2中风险", "00304", "0.015%", "0.02", "2.00"],
    ["00305", "诺安成长综合基金", "R3高风险", "00305", "0.020%", "0.03", "3.00"]
]

ai_products_info = [
    ["产品信息", "年化收益率", "年化波动率", "最大回撤", "夏普比率", "卡玛比率", "α系数", "重仓行业占比", "持股集中度"],
    ["易方达竞争优势企业混合A", "-19.97%", "18.48%", "-0.07%", "0.35", "0.15", "0.03", "20%", "30%"],
    ["景顺长城沪港深精选股票", "3.82%", "17.14%", "-29.12%", "0.45", "0.25", "0.06", "25%", "35%"]
]

ai_fund_ranking = {
    "股类基金": [
        ["景顺长城沪港深精选股票基金", 4.58],
        ["创金合信鑫禧混合A", 4.58],
        ["华富新趋势优选混合型证券投资基金", 4.58],
        ["泓信鑫回报灵活配置混合", 4.52],
        ["嘉合睿金混合C", 5.00],
        ["诺安先锋混合A", 4.53],
        ["北信瑞丰健康生活主题灵活配置混合A", 4.77],
        ["大成策略回报混合", 4.80],
        ["申万菱信安泰回报混合", 4.90],
        ["泰达宏利品质生活混合", 4.83]
    ],
    "债类基金": [
        ["国泰金鹿混合", 4.60],
        ["诺安行业轮动混合", 4.50],
        ["大成竞争优势混合", 4.40],
        ["国投融华基金", 4.30],
        ["鹏华普天收益基金", 4.20],
        ["长盛中小盘精选混合", 4.10],
        ["广发睿享稳健增利混合A", 4.00],
        ["国泰策略价值灵活混合", 3.90],
        ["南方利鑫灵活配置混合A", 3.80],
        ["鹏华动力增长混合型基金", 3.70]
    ]
}

# 调用大模型接口生成软文内容
def generate_article_from_api(sys_prompt,prompt):
    url = "http://218.77.34.87:7860/v1/chat/completions"
    headers = {"Content-Type": "application/json"}
    messages = [
        {"content": sys_prompt,"role": "system"},
        {"content": prompt,"role": "user"}
    ]
    data = {
        "model": "internlm2-chat-20b",
        "messages": messages,
        "temperature": 0.7,
        "top_p": 1,
        "logprobs": False,
        "top_logprobs": 0,
        "n": 1,
        "max_tokens": None,
        "stop": None,
        "stream": False,
        "presence_penalty": 0,
        "frequency_penalty": 0,
        "user": "string",
        "repetition_penalty": 1,
        "session_id": -1,
        "ignore_eos": False,
        "skip_special_tokens": True,
        "top_k": 40
    }
    response = requests.post(url, headers=headers, json=data)
    return response.json()['choices'][0]['message']['content']

paragraph=["【开场白+自我介绍】","【惯用资讯】","【破冰-客户持仓观察】","【分析-持仓基金表现】","【转折-目标基金引导】","【比较-目标基金优势】","【强化-优势指标解析】","【追单-营销跟进话术】"]


def loop_gen(customer, customer_fund, fund_type, ai_fund, news_type, communication_style):
    articles = []
    for i in range(8):
        prompt_res = prompt_choose(i, customer, customer_fund, fund_type, ai_fund, news_type, communication_style)
        res = generate_article_from_api(prompt_res[0], prompt_res[1])
        articles.append(paragraph[i])
        articles.append(res)
    return "\n\n".join(articles)

# 显示客户详细信息
def display_customer_info(customer_index):
    customer = customers[customer_index]
    customer_info = f"""
    **客户号**: {customer[0]}  
    **客户姓名**: {customer[1]}  
    **资金账号**: {customer[2]}  
    **年龄**: {customer[3]}  
    **总资产**: {customer[4]}  
    **风险等级**: {customer[5]}  
    **是否合格投资者**: {customer[6]}  
    """
    return customer_info

# 显示基金详细信息
def display_fund_info(fund_index):
    fund = funds[fund_index]
    fund_info = f"""
    **基金代码**: {fund[0]}  
    **产品名称**: {fund[1]}  
    **风险等级**: {fund[2]}  
    **产品代码**: {fund[3]}  
    **收益率**: {fund[4]}  
    **收益值**: {fund[5]}  
    **证券市值**: {fund[6]}  
    """
    return fund_info

# 创建客户数据框
customer_df = pd.DataFrame(customers, columns=["客户号", "客户姓名", "资金账号", "年龄", "总资产", "风险等级", "是否合格投资者"])
customer_df = customer_df.drop(columns=["客户号"])

# 创建基金数据框
fund_df = pd.DataFrame(funds, columns=["基金代码", "产品名称", "风险等级", "产品代码", "收益率", "收益", "持仓基金"])

# 排序并创建 AI精选基金列表数据框
def get_sorted_ai_fund_list(fund_type):
    sorted_funds = sorted(ai_fund_ranking[fund_type], key=lambda x: x[1], reverse=True)
    return [f"{fund[0]} (评分: {fund[1]})" for fund in sorted_funds]

# 获取基金详细信息
def get_fund_details(fund_name):
    for fund in ai_products_info:
        if fund[0] == fund_name:
            return {
                "年化收益率": fund[1],
                "年化波动率": fund[2],
                "最大回撤": fund[3],
                "夏普比率": fund[4],
                "卡玛比率": fund[5],
                "α系数": fund[6],
                "重仓行业占比": fund[7],
                "持股集中度": fund[8]
            }
    return {}

# Gradio 界面
with gr.Blocks(css=".gradio-radio label { display: block; }") as demo:
    with gr.Row():
        with gr.Column():
            gr.Markdown("### 基于大模型的基金对比软文创作")
            
            customer_radio = gr.Radio(
                choices=[f"{row['客户姓名']} ({row['资金账号']})" for _, row in customer_df.iterrows()],
                label="客户列表",
                value=None
            )
            
            customer_info_display = gr.Markdown()
            
            def update_customer_info(selected_customer):
                customer_index = [f"{row['客户姓名']} ({row['资金账号']})" for _, row in customer_df.iterrows()].index(selected_customer)
                customer_info = display_customer_info(customer_index)
                return customer_info

            customer_radio.change(update_customer_info, inputs=customer_radio, outputs=customer_info_display)
            
            fund_radio = gr.Radio(
                choices=[f"{row['产品名称']} (基金代码: {row['基金代码']})" for _, row in fund_df.iterrows()],
                label="客户持仓基金",
                value=None
            )
            
            fund_info_display = gr.Markdown()

            def update_fund_info(selected_fund):
                fund_index = [f"{row['产品名称']} (基金代码: {row['基金代码']})" for _, row in fund_df.iterrows()].index(selected_fund)
                fund_info = display_fund_info(fund_index)
                return fund_info

            fund_radio.change(update_fund_info, inputs=fund_radio, outputs=fund_info_display)
            
            ai_fund_type = gr.Radio(
                choices=list(ai_fund_ranking.keys()),
                label="AI精选类型",
                value="股类基金"
            )
            
            ai_fund_list = gr.Radio(
                choices=get_sorted_ai_fund_list("股类基金"),
                label="AI精选榜单",
                value=None
            )
            
            def update_ai_fund_list(fund_type):
                sorted_fund_choices = get_sorted_ai_fund_list(fund_type)
                return gr.Radio.update(choices=sorted_fund_choices)
            
            ai_fund_type.change(update_ai_fund_list, inputs=ai_fund_type, outputs=ai_fund_list)
            
            news_type = gr.Radio(
                choices=["热点资讯", "股市早报", "股市晚报"],
                label="惯用资讯",
                value="热点资讯"
            )
            
            communication_style = gr.Radio(
                choices=["风趣幽默", "稳健成熟"],
                label="沟通风格",
                value="风趣幽默"
            )
            
            fund_info_display_1 = gr.Markdown()
            fund_info_display_2 = gr.Markdown()

            def update_fund_info_display(customer_fund, ai_fund):
                customer_fund_details = get_fund_details(customer_fund)
                ai_fund_details = get_fund_details(ai_fund)
                
                customer_fund_info = f"""
                **客户持仓基金信息**:
                产品名称: {customer_fund}
                年化收益率: {customer_fund_details.get('年化收益率', '-19.97%')}
                年化波动率: {customer_fund_details.get('年化波动率', '18.48%')}
                最大回撤: {customer_fund_details.get('最大回撤', '-55.86%')}
                夏普比率: {customer_fund_details.get('夏普比率', '-1.1138')}
                卡玛比率: {customer_fund_details.get('卡玛比率', '-0.3575')}
                α系数: {customer_fund_details.get('α系数', '-0.0628')}
                重仓行业占比: {customer_fund_details.get('重仓行业占比', '酒、饮料和精制茶制造业')}
                持股集中度: {customer_fund_details.get('持股集中度', '52.86%')}
                """
                
                ai_fund_info = f"""
                **景顺长城沪港深精选股票基金信息**:
                产品名称: {ai_fund}
                年化收益率: {ai_fund_details.get('年化收益率', '10.05%')}
                年化波动率: {ai_fund_details.get('年化波动率', '13.23%')}
                最大回撤: {ai_fund_details.get('最大回撤', '-15.38%')}
                夏普比率: {ai_fund_details.get('夏普比率', '0.7911')}
                卡玛比率: {ai_fund_details.get('卡玛比率', '0.6536')}
                α系数: {ai_fund_details.get('α系数', '0.1282')}
                重仓行业占比: {ai_fund_details.get('重仓行业占比', '电力、热力生产和供应业')}
                持股集中度: {ai_fund_details.get('持股集中度', '47.62%')}
                """
                
                return customer_fund_info, ai_fund_info

            fund_radio.change(
                update_fund_info_display,
                inputs=[fund_radio, ai_fund_list],
                outputs=[fund_info_display_1, fund_info_display_2]
            )

            ai_fund_list.change(
                update_fund_info_display,
                inputs=[fund_radio, ai_fund_list],
                outputs=[fund_info_display_1, fund_info_display_2]
            )

            submit_btn = gr.Button("立即创作")

        with gr.Column():
            article_output = gr.Textbox(label="软文创作展示", lines=35)
            submit_btn.click(
                fn=lambda customer, fund, ai_fund, news_type, communication_style: loop_gen(customer,fund,ai_fund_type,ai_fund,news_type,communication_style),
                inputs=[customer_radio, fund_radio, ai_fund_list, news_type, communication_style],
                outputs=article_output
            )

demo.launch(server_name="127.0.0.1", server_port=7860, share=True)
